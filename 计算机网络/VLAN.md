# 虚拟局域网VLAN的实现机制（湖科大教书匠）
是在交换机上实现的：
交换机要能够：
1. 处理带有VLAN标记的帧
IEEE 802.1Q帧
2. 交换机的各端口可以支持不同的端口类型 

## IEEE 802.1Q帧
对以太网的MAC帧格式进行了扩展，插入了**4字节的VLAN标记**
其中最后12bit称为VLAN标识符VID（0 ~ 4095，实际有效范围是1 ~ 4094），唯一地标志了以太网帧属于哪一个VLAN
该类型的帧是交换机来处理，而不是用户主机
**当交换机收到普通的以太网帧时，会将其插入4字节的VLAN标记转变为802.1Q帧，即“打标签”**
**当交换机转发802.1Q帧时，可能会删除其4字节的VLAN标记转变为普通以太网帧，即“去标签”**

## 交换机的端口类型
交换机的端口类型有以下三种：
1. Access
2. Trunk
3. Hybrid

交换机各端口的缺省VLAN ID
例如，思科交换机在用户未配置VLAN时，所有端口都默认属于VLAN1
华为交换机上缺省VLAN ID称为Port VLAN ID，即端口VLAN ID（PVID）。交换机的每个端口有且仅有一个PVID

### Access
用于连接用户计算机，只能属于一个VLAN
Access端口的PVID值与端口所属VLAN的ID相同（默认为1）
#### Access端口接收处理方法：
一般只接受“未打标签”的普通以太网MAC帧，根据接收帧的端口的PVID给帧打标签，插入4字节VLAN标记字段
#### Access端口发送处理方法：
若帧中的VID与端口的PVID相等，则去标签并转发，否则不转发

### Trunk端口
一般用于交换机之间或交换机与路由器之间的互连
Trunk端口可以属于多个VLAN
用户可以设置Trunk端口的PVID值，默认为1




# VLAN基础知识（来自知乎）
***https://zhuanlan.zhihu.com/p/35616289***
## 1 什么是VLAN？
VLAN所指的LAN特指使用路由器分割的网络：广播域
**广播域：广播帧（目标MAC地址全为1）所能传递到的范围**
本来二次交换机只能构建单一的广播域，使用VLAN后能将网络分割成多个广播域
广播帧较常见：ARP、DHCP、RIP协议

路由器可以分割广播域（使用路由器上的LAN Interface网络接口），但是路由器上面的网络接口最多也就1~4个，而且使用路由器也不自由，因为完全取决于路由器的网络接口个数


## 实现VLAN的机制
### 交换机如何使用VLAN分割广播域？
交换机接收到来自某一个端口的广播帧后，转发到除源端口外的所有端口。
配置VLAN后，交换机就只会把它转发给同属于一个VLAN的其他端口（即：通过限制广播帧的转发范围分割了广播域，也就是通过VLAN ID来区分）

### 直观地描述VLAN
可以理解为：一台交换机在逻辑上分割成了多台交换机，而且VLAN间无法通信

#### VLAN间如何通信？
VLAN间的通信需要路由器提供中继服务————“VLAN间路由”（可以用普通路由器来实现，也可以使用三层交换机）。
VLAN通信需要用到交换机的路由功能：
##### 访问链接（Access Link）
    是指：“只属于一个VLAN，且仅向该VLAN转发数据帧”的端口，访问链接所连的一般是客户机。
通常**设置VLAN的顺序**是：
(1) 生成VLAN
(2) 设定访问链接(决定各端口属于哪一个VLAN)
    可以设置静态VLAN，或者动态VLAN。
**静态VLAN————基于端口**
明确各端口属于哪个VLAN，需要一个个指定，很麻烦
而且实际需求中有可能频繁改变拓扑结构，这显然不合适

**动态VLAN**
根据每个端口所连的计算机，随时改变端口所属的VLAN
根据OSI参照模型的某一层信息，动态VLAN可分为三类：
1. 基于MAC地址的VLAN
    查询所连计算机网卡的MAC地址来决定端口所属的VLAN
    如果设定MAC地址X为VLAN“10”，那么无论连接哪个端口，该端口都会被划分到VLAN10。
    （本质上是在数据链路层设定访问链接的办法）

2. 基于子网的VLAN
    基于IP地址（网络号）来决定所属的VLAN，即便计算机所连交换机的端口发生变化也无所谓
    （本质上是在OSI第三层设定访问链接的方法）

3. 基于用户名的VLAN
    本质上是属于OSI第四层以上的信息

总的来说，决定端口所属VLAN时利用的信息在OSI中的层面越高，就越适于构建灵活多变的网络。


##### 汇聚链接（Trunk Link）
如果需要设置跨越多台交换机的VLAN？
在规划企业级网络时，很有可能会遇到隶属于同一部门的用户分散在同一座建筑物中的不同楼层的情况，这时可能就需要考虑到如何跨越多台交换机设置VLAN的问题了。
结论：交换机之间需进行连接，使用额外的端口。
但这个办法从扩展性和管理效率来看都不好。
例如，在现有网络基础上再新建VLAN时，为了让这个VLAN能够互通，就需要在交换机间连接新的网线。
建筑物楼层间的纵向布线是比较麻烦的，一般不能由基层管理人员随意进行。并且，VLAN越多，楼层间(严格地说是交换机间)互联所需的端口也越来越多，交换机端口的利用效率低是对资源的一种浪费、也限制了网络的扩展。
为了避免这种低效率的连接方式，人们想办法**让交换机间互联的网线集中到一根上**，这时使用的就是汇聚链接(Trunk Link)。

汇聚链路上流通的**数据帧，都被附加了用于识别分属于哪个VLAN的特殊信息**。
用户只需要简单地**将交换机间互联的端口设定为汇聚链接**就可以了。这时使用的网线还是普通的UTP线，而不是什么其他的特殊布线。


**汇聚链接如何实现跨越交换机间的VLAN？**
如果把交换机的某个端口设置为汇聚链路（Trunk Link），那么当数据包通过汇聚链路时会自动附加VLAN识别信息。
考虑以下场景：交换机A、B分别连接在交换机1、2上，两台交换机使用汇聚链接进行VLAN间通信。
A发送数据帧先通过交换机1、再经过汇聚链路（此时在数据帧上附加表示VLAN2的标记，这个VLAN识别信息，可能是支持标准的`IEEE 802.1Q协议`，也可能是思科自带的ISL），然后到达交换机2，这时检查VLAN标识，发现是属于VLAN2的，去除标记后，将复原的数据帧只转发给属于VLAN2的端口，那么就发送给了主机B（这时的转发，是经过了确认目标MAC地址并与MAC地址列表对比后只转发给目标MAC地址所连接的端口，只有当**数据帧是一个广播帧，多播帧、或者目标不明的帧，它才会被转发到所有属于VLAN2的端口**）。
显然，汇聚链路上流通着多个VLAN的数据，自然负载较重，因此必须支持100Mbps以上的传输速度。

另外，默认条件下，汇聚链接会转发交换机上存在的所有VLAN的数据。换一个角度看，可以认为汇聚链接(端口)同时属于交换机上所有的VLAN。由于实际应用中很可能并不需要转发所有VLAN的数据，因此为了减轻交换机的负载、也为了减少对带宽的浪费，我们可以通过用户设定限制能够经由汇聚链路互联的VLAN。

##### IEEE802.1Q
俗称Dot One Q，对数据帧附加VLAN识别信息的协议
相比以太网协议，本协议增加了**4B信息**：
1. TPID（Tag Protocol IDentifier）
    0x8100（表示网络帧类型为802.1Q类型）

2. TCI（Tag Control Information）
包含12bit的VLAN ID（最多识别4096个VLAN）

当数据帧离开汇聚链路时，TPID和TCI都被去除（重新进行CRC计算）
PS：思科的协议是对以太网帧进行封装/去除


### 为什么必须要VLAN间路由
局域网通信必然要指定目的MAC地址，而获取MAC地址，使用TCP/IP协议时需要使用ARP得到，它是通过广播的，VLAN间无法通信，那么两台计算机也就分属不同的广播域，根本收不到广播报文，也就无法得到MAC地址

路由功能，一般主要由路由器提供。但在现在的局域网里，我们也经常利用带有路由功能的交换机——三层交换机(Layer 3 Switch)来实现。


#### 使用路由器进行VLAN间路由
**路由器和交换机的接线方式**
1. 将路由器与交换机上的每个VLAN分别连接
    交换机和路由器互联的每个端口设置为**访问链接**（交换机需要设置几个VLAN就启用几个端口），那么交换机剩余端口就可以连接主机
缺点显而易见：每增加一个新的VLAN，就需要占用路由器一个LAN接口（PS：路由器一般没几个LAN接口）

2. 不论VLAN有多少个，路由器和交换机都只用一条网线连接
这个方案使用到了**汇聚连接（Trunk Link）**
交换机和路由器的端口都要支持汇聚连接，在路由器上要定义对应各个VLAN的子接口，在逻辑上把物理端口分割为多个虚拟端口
总之不管后续如何在交换机上添加VLAN，仍然只需一根网线就足够

**同一VLAN内的通信**
还是经典的交换机自学习转发帧的路子


**不同VLAN间的通信**
首先，主机A匹配自身IP和目的IP，发现不属于一个网段，于是给默认网关转发数据帧，这需要首先用ARP协议获取路由器的MAC地址。
然后数据发往交换机，交换机解出数据所属的VLAN，检索MAC地址列表，转发给汇聚链路（因为汇聚链路会被看作属于所有的VLAN）。
然后交换机知道了数据（目的MAC地址是路由器的MAC地址，而IP地址是最终的IP地址）要发往路由器。
然后路由器识别出数据帧是属于某一VLAN的，于是由对应的端口接收。
**接着，路由器根据路由表，判断向哪里中继。**
由于目标网络是另一个VLAN，并且该网络通过子接口与路由器直连，此时，**数据帧的目的MAC地址被改写成另一台主机的MAC地址**，并且被附加上属于另一个VLAN的识别信息。
交换机收到来自路由器的数据帧后，根据VLAN标识信息得知该发给哪个端口，发之前去除VLAN识别信息，最终另一台主机成功收到数据帧。



#### 三层交换机
如果使用路由器进行VLAN间路由的话，随着VLAN之间流量的不断增加，很可能导致路由器成为整个网络的瓶颈。

交换机使用被称为ASIC(ApplicationSpecified Integrated Circuit)的专用硬件芯片处理数据帧的交换操作，在很多机型上都能实现以缆线速度(Wired Speed)交换。
**路由器则基本上是基于软件处理的。即使以缆线速度接收到数据包，也无法在不限速的条件下转发出去，因此会成为速度瓶颈**。
就VLAN间路由而言，流量会集中到路由器和交换机互联的汇聚链路部分，这一部分尤其特别容易成为速度瓶颈。并且从硬件上看，由于需要分别设置路由器和交换机，在一些空间狭小的环境里可能连设置的场所都成问题。

为了解决上述问题，三层交换机应运而生。三层交换机，本质上就是“带有路由功能的(二层)交换机”。
路由属于OSI参照模型中第三层网络层的功能，因此带有第三层路由功能的交换机才被称为“三层交换机”。

