# 虚拟局域网VLAN的实现机制（湖科大教书匠）
是在交换机上实现的：
交换机要能够：
1. 处理带有VLAN标记的帧
IEEE 802.1Q帧
2. 交换机的各端口可以支持不同的端口类型 

## IEEE 802.1Q帧
对以太网的MAC帧格式进行了扩展，插入了**4字节的VLAN标记**
其中最后12bit称为VLAN标识符VID（0 ~ 4095，实际有效范围是1 ~ 4094），唯一地标志了以太网帧属于哪一个VLAN
该类型的帧是交换机来处理，而不是用户主机
**当交换机收到普通的以太网帧时，会将其插入4字节的VLAN标记转变为802.1Q帧，即“打标签”**
**当交换机转发802.1Q帧时，可能会删除其4字节的VLAN标记转变为普通以太网帧，即“去标签”**

## 交换机的端口类型
交换机的端口类型有以下三种：
1. Access
2. Trunk
3. Hybrid

交换机各端口的缺省VLAN ID
例如，思科交换机在用户未配置VLAN时，所有端口都默认属于VLAN1
华为交换机上缺省VLAN ID称为Port VLAN ID，即端口VLAN ID（PVID）。交换机的每个端口有且仅有一个PVID

### Access
用于连接用户计算机，只能属于一个VLAN
Access端口的PVID值与端口所属VLAN的ID相同（默认为1）
#### Access端口接收处理方法：
一般只接受“未打标签”的普通以太网MAC帧，根据接收帧的端口的PVID给帧打标签，插入4字节VLAN标记字段
#### Access端口发送处理方法：
若帧中的VID与端口的PVID相等，则去标签并转发，否则不转发

### Trunk端口
一般用于交换机之间或交换机与路由器之间的互连
Trunk端口可以属于多个VLAN
用户可以设置Trunk端口的PVID值，默认为1




# VLAN基础知识（来自知乎）
***https://zhuanlan.zhihu.com/p/35616289***
## 1 什么是VLAN？
VLAN所指的LAN特指使用路由器分割的网络：广播域
**广播域：广播帧（目标MAC地址全为1）所能传递到的范围**
本来二次交换机只能构建单一的广播域，使用VLAN后能将网络分割成多个广播域
广播帧较常见：ARP、DHCP、RIP协议

路由器可以分割广播域（使用路由器上的LAN Interface网络接口），但是路由器上面的网络接口最多也就1~4个，而且使用路由器也不自由，因为完全取决于路由器的网络接口个数


## 实现VLAN的机制
### 交换机如何使用VLAN分割广播域？
交换机接收到来自某一个端口的广播帧后，转发到除源端口外的所有端口。
配置VLAN后，交换机就只会把它转发给同属于一个VLAN的其他端口（即：通过限制广播帧的转发范围分割了广播域，也就是通过VLAN ID来区分）

### 直观地描述VLAN
可以理解为：一台交换机在逻辑上分割成了多台交换机，而且VLAN间无法通信

#### VLAN间如何通信？
VLAN间的通信需要路由器提供中继服务————“VLAN间路由”（可以用普通路由器来实现，也可以使用三层交换机）。
VLAN通信需要用到交换机的路由功能：
##### 访问链接（Access Link）
    是指：“只属于一个VLAN，且仅向该VLAN转发数据帧”的端口，访问链接所连的一般是客户机。
通常**设置VLAN的顺序**是：
(1) 生成VLAN
(2) 设定访问链接(决定各端口属于哪一个VLAN)
    可以设置静态VLAN，或者动态VLAN。
**静态VLAN————基于端口**
明确各端口属于哪个VLAN，需要一个个指定，很麻烦
而且实际需求中有可能频繁改变拓扑结构，这显然不合适

**动态VLAN**
根据每个端口所连的计算机，随时改变端口所属的VLAN
根据OSI参照模型的某一层信息，动态VLAN可分为三类：
1. 基于MAC地址的VLAN
    查询所连计算机网卡的MAC地址来决定端口所属的VLAN
    如果设定MAC地址X为VLAN“10”，那么无论连接哪个端口，该端口都会被划分到VLAN10。
    （本质上是在数据链路层设定访问链接的办法）

2. 基于子网的VLAN
    基于IP地址（网络号）来决定所属的VLAN，即便计算机所连交换机的端口发生变化也无所谓
    （本质上是在OSI第三层设定访问链接的方法）

3. 基于用户名的VLAN
    本质上是属于OSI第四层以上的信息

总的来说，决定端口所属VLAN时利用的信息在OSI中的层面越高，就越适于构建灵活多变的网络。


##### 汇聚链接（Trunk Link）
如果需要设置跨越多台交换机的VLAN？
在规划企业级网络时，很有可能会遇到隶属于同一部门的用户分散在同一座建筑物中的不同楼层的情况，这时可能就需要考虑到如何跨越多台交换机设置VLAN的问题了。
结论：交换机之间需进行连接，使用额外的端口。
但这个办法从扩展性和管理效率来看都不好。
例如，在现有网络基础上再新建VLAN时，为了让这个VLAN能够互通，就需要在交换机间连接新的网线。
建筑物楼层间的纵向布线是比较麻烦的，一般不能由基层管理人员随意进行。并且，VLAN越多，楼层间(严格地说是交换机间)互联所需的端口也越来越多，交换机端口的利用效率低是对资源的一种浪费、也限制了网络的扩展。
为了避免这种低效率的连接方式，人们想办法**让交换机间互联的网线集中到一根上**，这时使用的就是汇聚链接(Trunk Link)。

汇聚链路上流通的**数据帧，都被附加了用于识别分属于哪个VLAN的特殊信息**。
用户只需要简单地**将交换机间互联的端口设定为汇聚链接**就可以了。这时使用的网线还是普通的UTP线，而不是什么其他的特殊布线。





































