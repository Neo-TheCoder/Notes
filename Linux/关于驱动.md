# 科普
# 概念
## 驱动程序与应用程序的区别
驱动程序本身也是代码，但与应用程序不同，它不会主动去运行，而是被调用。这调用者就是应用程序。

驱动与应用是服务与被服务的关系。驱动是为应用服务的。因为应用程序很多时候需要用到硬件设备，但不能直接操作硬件设备，所以通过`系统调用`陷入`内核调用驱动`，从而操作硬件。（用户程序 -- 内核 -- 驱动 -- 硬件）
（内核会根据系统调用号，去调用相应的设备驱动程序）
系统调用：内核给用户程序提供服务。
应用与驱动程序在系统中所处位置不同,决定了它们代码运行模式也不一样。
* 应用程序运行在用户空间(用户态)。
* 驱动代码运行于内核空间(内核态)。

由于驱动必然在内核态，所以无法调用到标准C库的函数（用户态），内核会去实现大部分常用的函数，供驱动调用。

# 分类
* 字符设备
    I/O过程中，以字符为单位传输
    用户请求和硬件读写是同步的
* 块设备（磁盘、闪存）
    I/O过程中，以块（内存缓冲）为单位传输
    用户请求和硬件读写是异步的
* 网络设备
网络设备是一类特殊的设备，它不像字符设备或块设备那样通过对应的设备文件访问，也不能直接通过read 或 write 进行数据请求，而是通过`socket接口函数`进行访问。

## 设备文件
设备文件存放于/dev目录下
```
设备类型（首字母 c=字符设备 b=块设备）  主/从设备号
```
linux把设备抽象成文件，“一切设备皆文件”。所以对硬件的操作全部抽象成对`文件的操作`。
驱动是硬件的最直接操作者，设备文件是用户程序与设备驱动的一个接口，应用程序通过操作`设备文件`来调用设备驱动程序。

### 应用程序如何通过设备文件找到设备驱动？
主设备号：用于标识驱动程序，主设备号一样的设备文件将使用同一类驱动程序。(1-254)
从设备号：用于标识使用同一驱动程序的不同具体硬件。(0-255)
例如：6818开发板中的串口设备，主设备号标识串口这类设备，从设备号标识具体的某个串口。
`cat /proc/devices`命令可以查看当前系统中 主设备号的使用情况和其对应的硬件设备。

## 编程
linux内核整体结构非常庞大，包含的组件非常多。我们怎样选择性的把需要的部分包含在内核中呢？
linux内核抛弃把所有功能模块都编译到内核的做法，采用了模块化的方法（`.ko`）将各组件灵活添加和删减，并且驱动模块还可以动态加载、删除。
好处：
内核体积小：不需要的组件可以不编入内核
开发灵活：模块可以同普通软件一样，从内核中添加或删除
平台无关、节省内存

* 模块加载函数：
完成相关资源申请、硬件初始化以及驱动的注册
若初始化成功返回0,失败返回错误值
模块加载函数必须以"module_init(函数名)"形式进行声明
* 模块卸载函数：
释放已申请资源、注销驱动
在模块卸载时被执行，不返回任何值
函数需要以"module_exit(函数名)"的形式进行声明

示例：
```c
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/init.h>

/*模块加载函数*/
int __init xxx_module_init(void) { ... }
/*模块卸载函数*/
void __exit xxx_module_exit(void) { ... }
/*声明模块加载函数宏*/
module_init(xxx_module_init);
/*声明模块卸载函数宏*/
module_exit(xxx_module_exit);
/*声明模块作者*/
MODULE_AUTHOR("qfedu");
/*模块许可证明，描述内核模块的许可权限*/
MODULE_LICENSE("GPL");
```

## 编译
Linux内核模块的编译方法有两种：
1. 放入Linux内核源码中编译（依赖内核的完整源码）
    将写好的模块放入Linux内核任一目录下
    修改相应目录下的Kconfig和Makefile文件
    执行make modules
    会在相同目录下生成与源文件同名的.ko文件
```
lsmod 列举当前系统中的所有模块
insmod xxx.ko 加载指定模块到内核
rmmod xxx 卸载指定模块(不需要.ko后缀)
```

2. 采用独立的方法编译模块（out-of-tree）
    指向已安装的内核头文件或kbuild内核构建系统（定义哪些源码参与编译、生成什么目标）（而不使用kconfig内核配置系统），单独编译.ko





